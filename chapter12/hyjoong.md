# 12장: 모든 웹 개발자가 관심을 가져야 할 핵심 웹 지표

- [12장: 모든 웹 개발자가 관심을 가져야 할 핵심 웹 지표](#12장-모든-웹-개발자가-관심을-가져야-할-핵심-웹-지표)
  - [12.1 웹사이트와 성능](#121-웹사이트와-성능)
  - [12.2 핵심 웹 지표란?](#122-핵심-웹-지표란)
  - [12.3 최대 콘텐츠풀 페인트(LCP)](#123-최대-콘텐츠풀-페인트lcp)
    - [12.3.1 정의](#1231-정의)
    - [12.3.2 의미](#1232-의미)
    - [12.3.3 예제](#1233-예제)
    - [12.3.4 기준 점수](#1234-기준-점수)
    - [12.3.5 개선 방안](#1235-개선-방안)
  - [12.4 최초 입력 지연(FID)](#124-최초-입력-지연fid)
    - [12.4.1 정의](#1241-정의)
    - [12.4.2 의미](#1242-의미)
    - [12.4.3 예제](#1243-예제)
    - [12.4.4 기준 점수](#1244-기준-점수)
    - [12.4.5 개선 방안](#1245-개선-방안)
  - [12.5 누적 레이아웃 이동(CLS)](#125-누적-레이아웃-이동cls)
    - [12.5.1 정의](#1251-정의)
    - [12.5.2 의미](#1252-의미)
    - [12.5.3 예제](#1253-예제)
    - [12.5.4 기준 점수](#1254-기준-점수)
    - [12.5.5 개선 방안](#1255-개선-방안)
    - [12.5.6 핵심 웹 지표는 아니지만 성능 확인에 중요한 지표들](#1256-핵심-웹-지표는-아니지만-성능-확인에-중요한-지표들)
  - [12.6 정리](#126-정리)

<br>

## 12.1 웹사이트와 성능

사용자가 웹사이트에 접속했을 때 공통적으로 기대하는 사항은 다음과 같다

1. 웹 사이트를 방문한 목적을 손쉽게 달성할 수 있어야 한다
2. 첫 번째 목적을 달성하는 데 걸리는 시간이 짧아야 한다
3. 웹사이트에서 개인정보가 누출되는 등의 사고 없이 보안이 철저해야 한다

<br>

## 12.2 핵심 웹 지표란?

구글에서 만든 지표로, 웹사이트에서 뛰어난 사용자 경험을 제공하는 데 필수적인 지표를 일컫는 용어다.
구글에서 핵심 웹 지표로 꼽는 지표는 다음과 같다.

#### 1. 최대 콘텐츠풀 페인트(LCP)

#### 2. 최초 입력 지연(FID)

#### 3. 누적 레이아웃 이동(CLS)

그리고 다음 두 지표는 핵심까지는 아니지만, 특정 문제를 진단하는 데 사용될 수 있다.

#### 1. 최초 바이트까지의 시간(TTFB)

#### 2. 최초 콘텐츠풀 시간(FCP)

  <br>

## 12.3 최대 콘텐츠풀 페인트(LCP)

### 12.3.1 정의

페이지가 처음으로 로드를 시작한 시점부터 뷰포트 내부에서 **가장 큰 이미지 또는 텍스트를 렌더링하는 데 걸린 시간**을 말한다

뷰포트 내부에서 '큰 이미지'와 텍스트'는 다음과 같이 정의돼 있다.

```javascript
- <img>
- <svg> 내부의 <image>
- poster 속성을 사용하는 <video>
- url()을 통해 불러온 배경 이미지가 있는 요소
- 텍스트와 같이 인라인 텍스트 요소를 포함하고 있는 블록 레벨 요소
  - 이 블록 레벨 요소에는 <p>, <div> 등이 포함된다.
```

LCP란 사용자의 기기가 노출하는 뷰포트 내부에서 가장 큰 영역을 차지하는 요소로 렌더링되는 데 얼마나 걸리는지를 측정하는 지표인 것이다.

### 12.3.2 의미

'웹페이지가 로딩이 완료되어 사용자에게 노출되기까지 걸리는 시간'의 기준은 무엇일까?

가장 먼저 떠오르는 방법은 `DOMContentLoaded`이벤트가 호출되는 시간일 것이다.

`DOMContentLoaded`는 HTML문서를 완전히 불러오고 파싱했을 때 발생하는 이벤트로, 페이지의 document를 대상으로 일어나며 단 **한 번만 호출된다**.

=> 사용자에게 페이지의 정보를 화면에 전달하는 속도를 객관적으로 판단하기 위한 지표로 만들어진 것이다.

### 12.3.3 예제

LCP는 페이지 로딩에 따라 변화하는 지표다.

### 12.3.4 기준 점수

LCP에서 좋은 점수란 해당 지표가 **2.5초** 내로 응답이 오는 것이다.

### 12.3.5 개선 방안

#### 텍스트는 언제나 옳다

LCP지표에서 좋은 점수를 얻는 가장 확실한 방법은 뷰포트 최대 영역에 이미지가 아닌 문자열을 넣는 것이다.

아무리 이미지를 최적화하더라도 추가적인 리소스 다운로드가 필요한 이미지보다 텍스트 노출이 훨씬 더 빠르다.

<br>

## 12.4 최초 입력 지연(FID)

### 12.4.1 정의

순간적으로 몰린 엄청난 트래픽 때문에 웹사이트가 클릭이나 타이핑이 되지 않아 아무런 작업을 하지 못한 경험이 있을 것이다. 아무리 페이지가 빠르게 로딩되더라도 사용자가 `클릭`같은 상호작용을 할 수 없다면 웹사이트가 느리다고 생각할 것이다.

웹페이지의 로딩 속도만큼 중요한 것이 웹사이트의 반응 속도다. 이러한 웹사이트의 반응성을 측정하는 지표가 바로 최초 입력 지연 (FID: First Input Delay)이다.

#### FID란

> 사용자가 페이지와 처음 상요 작용할 때부터 해당 상호 작용에 대한 응답으로 브라우저가 실제로 이벤트 핸들러 처리를 시작하기까지의 시간을 측정한다.

### 12.4.2 의미

대부분 이벤트 핸들러에는 이벤트를 즉시 처리하기 위한 코드를 작성하지만 웹사이트 내부의 이벤트가 반응이 늦어질 때가 있다.

이러한 이유는 해당 입력을 처리해야 하는 브라우저의 메인 스레드가 바쁘기 때문이다.
대규모 렌더링이 일어나고 있거나, 대규모 JS파일을 분석하고 실행하는 등 다른 작업을 처리하는 데 리소스를 할애하고 있기 때문이다.

자바스크립트는 '싱글 스레드'이기 때문에 이벤트 리스너와 같은 다른 작업을 실행할 수 없어 지연이 발생한다.

즉, 이벤트가 발생하는 시점에 최대한 메인 스레드가 다른 작업을 처리할 수 있도록 여유을 만들어 둬야 사용자에게 빠른 반응성을 보장할 수 있다.

### 12.4.3 예제

### 12.4.4 기준 점수

최초 입력 지연의 좋은 점수를 얻기 위해서는 100ms 이내로 응답이 와야하며, 300ms 이내인 경우 보통, 그 이하의 경우에는 나쁨으로 처리된다.

### 12.4.5 개선 방안

#### 1. 실행에 오래 걸리는 긴 작업을 분리

긴 작업이 있다면 여러 개로 분리해 처리하는 것도 좋다. 웹페이지 최초 로딩에 필요하지 않은 내용을 나중에 불러오는 것도 포함된다.

예를들어 웹페이지에서 팝업이나 레이어가 있을 경우, 사용자의 액션으로 인해 노출되는 요소들은 당장의 로딩에 필요하지 않은 리소스다. 이러한 리소스는 리액트의 `Suspense`와 `lazy`를, 혹은 Next.js의 dynamic을 이용해 나중에 불러오게 할 수 있다.

#### 2. 자바스크립트 코드 최소화

현대의 번들링 도구는 코드 번들링에 필요한 코드만 모아서 최종 프로적션 JS코드를 생성한다. 개발자가 작성한 코드라도 빌드 과정에서 사용되지 않는 코드로 간주되면 번들링에서 제거된다.

#### 3. 타사 자바스크립트 코드 실행의 지연

Google Analytics나 Firebase와 같이 웹페이지 통계 집계를 위해 제3자가 만든 타사 스크립트를 넣는 경우도 많다. 이 코드의 실행으로 인해 메인 스레드가 잠시 점유되고, 이로 인해 사용자에게 좋지 않은 반응성을 제공될 수가 있다.

이러한 타사 스크립트는 대부분 웹페이지 로드에 중요한 자원이 아니므로 `<script>`의 `async`나 `defer`을 이용해 지연 불러오기를 하는 것이 좋다.
<br>

## 12.5 누적 레이아웃 이동(CLS)

### 12.5.1 정의

웹 사이트에서 로딩이 끝난 줄 알고 무언가를 클릭하려고 했는데 그 사이 다른 요소가 로딩되면 원래 클릭하려고 했던 요소를 클릭하지 못 하는 경우가 있을 것이다.
이처럼 페이지의 생명주기 동안 발생하는 모든 예기치 않은 이동에 대한 지표를 계산하는 것이 바로 누적 레이아웃 이동(CLS)이다.

### 12.5.2 의미

리액트로 만들어진 웹사이트는 `useEffect`를 사용하며, useEffect는 렌더링이 한 번 끝난 이후에 콜백 함수는 실행하는 훅이다.
useEffect가 많을수록 클라이언트에서 처리해야 하는 작업이 많아진다.

### 12.5.3 예제

### 12.5.4 기준 점수

![image](https://github.com/diving-react/study-react-deepdive/assets/70426440/6169b779-285b-4a17-bbbd-c0f14fda3abc)

- 0.1이하: 좋음
- 0.25이하: 보통
- 0.25초과: 나쁨

### 12.5.5 개선 방안

#### 1. 삽입이 예상되는 요소를 위한 추가적인 공간 확보

대부분의 큰 누적 레이아웃 이동은 클라이언트에서 삽입되는 동적인 요소로 인해 발생한다.

- 1.1 useLayoutEffect사용

useEffect대신 useLayoutEffect를 사용해서 해결할 수 있지만, 동기적으로 발생해 브라우저의 페인팅 작업에 영향을 미치기 때문에 로딩이 오래 걸리는 것과 같이 보일 수 있다.
CLS를 막으려다 다른 모든 작업에 악 영향을 끼칠 수 있어서 신중하게 선택해야 한다.

- 1.2 스켈레톤 UI 사용

스켈레톤 UI를 먼저 나타내는 방법이 있지만 해당 영역이 뜨지 않는 케이스가 있다면 CLS현상을 방지하기 어렵다.

- 1.3 서버사이드 렌더링

제일 좋은 방법으로 서버에서 동적인 요소의 유무를 사전에 판단해 클라이언트에 HTML을 미리 제공해 준다면 깔끔하게 처리될 것이다.

#### 2. 폰트 로딩 최적화

폰트로 인해 발생할 수 있는 문제는 크게 두 가지다.

- FOUT: HTML문서에서 지정한 폰트가 보이지 않고 대체 기본 폰트로 보이고 있다가 뒤늦게 폰트가 적용되는 현상
- FOIT: HTML문서에서 지정한 폰트가 보이지 않고, 기본 폰트도 없어서 텍스트가 없는 채로 있다가 뒤늦게 폰트가 로딩되면서 페이지에 렌더링되는 현상

#### 3. 적절한 이미지 크기 설정

### 12.5.6 핵심 웹 지표는 아니지만 성능 확인에 중요한 지표들

#### 1. 최초 바이트까지의 시간 (TTFB: Time To First Byte)

브라우저가 웹페이지의 첫 번째 바이트를 수신하는데 걸리는 시간

즉, 페이지를 요청했을 때 요청이 완전히 완료되는 데 걸리는 시간이 아닌 최초의 응답이 오는 바이트까지가 얼마나 걸리는지를 측정하는 지표다.

특히 서버 사이드 렌더링을 하고 있는 경우 주의 깊게 봐야한다. 서버에서 첫 번째 HTML을 만들기 위해 해야 하는 작업이 많거나 느릴 수록 TTFB의 시간이 길어진다.

- renderToNodeStream이나 renderToStaticNodeStream과 같은 스트리밍 API를 사용해서 TTFB를 개선할 수 있다

#### 2, 최초 콘텐츠풀 페인트(FCP: First Contentful Paint)

페이지가 로드되기 시작한 시점부터 페이지 콘텐츠의 일부가 화면에 렌더링될 때까지의 시간을 측정한다. 웹사이트에 접속한 순간부터 페이지에 텍스트, 이미지, svg 등.. 이 뜨기 시작한 시간을 의미한다.

![image](https://github.com/diving-react/study-react-deepdive/assets/70426440/6dc238d9-5e21-47b7-b449-f50861abd440)

- 1.8초 이내: 좋음
- 3.0초 이내: 보통
- 3.0초 초과: 나쁨
  <br>

## 12.6 정리
