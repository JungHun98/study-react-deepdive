# 13장 웹 페이지 성능을 측정하는 다양한 방법

단순히 개발자의 컴퓨터에서 애플리케이션의 성능을 측정하는 방법부터 원격지에 있는 서버에서 확인하는 방법까지 성능 측정의 방식은 다양하다. 지표를 확인하는 서로 다른 방법을 통해 웹 페이지의 성능을 객관적으로 파악하는 방법을 익혀보자

## 애플리케이션에서 확인하기

CRA(Create React App), CNA(Create Next App)은 자체적으로 PerformanceObserver를 바탕으로 성능을 측정할 수 있는 API를 구현해 놓았다.

## 구글 라이트하우스

구글 라이트하우스는 구글에서 제공하는 웹 페이지 성능 측정 도구다. 웹 성능의 핵심지표 뿐 아니라 접근성 PWA, SEO 등 웹 페이지를 둘러싼 다양한 요소들을 측정하고 점검할 수 있다.

Device 항목에서는 측정하고자 하는 페이지 접근 환경(Mobile, Desktop)을, Category에서는 확인하고 싶은 지표를 선택할 수 있다. 이때 측정 Mode를 선택해 성능 측정 방식을 선택할 수 있다.

### 탐색 모드

일반적으로 페이지에 접속했을 때부터 페이지 로딩이 완료될 때까지의 성능을 측정하는 모드다. 이 모드로 측정을 시작하면 페이지를 처음부터 다시 불러와 페이지 로딩이 끝날 때까지 각각의 지표를 수집한다.

- Performance: 웹 페이지의 성능과 관련된 지표를 확인할 수 있다.
    - 최초 콘텐츠풀 페인트, 최대 콘텐츠풀 페인트, 누적 레이아웃 이동 등의 지표가 측정된다.
    - Time to Interaction: 페이지에서 사용자가 완전히 사용호작용 할 수 있을 때까지 걸리는 시간을 측정한다.
    - Speed Index: 페이지가 로드되는 동안 콘텐츠가 얼마나 빨리 시작적으로 표시되는지 계산한다.
    - Total Blocking Time: 메인 스레드에서 특정 시간 이상 실행되는 작업, 즉 긴 작업이 수행될 때마다 메인 스레드가 차단된 것으로 간주한다. 이렇게 메인 스레드에서 실행하는 작업이 50ms 이상 걸리면 이를 긴 작업이라고 간주하고, 이런 작업을 모은 지표다.
        - 모든 긴 작업이 대상은 아니며, 최초에 사용자에게 무언가 콘텐츠를 보여줬을 때부터 상호 작용까지 걸리는 시간 사이의 작업만을 대상으로 한다.
- 접근성
    - 웹 접근성을 의미하며, 장애인 및 고령자 등 신체적으로 불편한 사람들이 일반적인 사용자와 동등하게 웹 페이지를 이용할 수 있도록 보장하는 것을 의미한다.
    - 접근성 점수가 낮은 부분이 있으면 이 영역에서 확인할 수 있으며, 어떻게 수정해야 하는지도 알려준다.
- 권장 사항
    - 웹 사이트를 개발할 때 고려해야 할 요소들을 얼마나 지키고 있는지 확인할 수 있다.
    - 보안
        - CSP가 XSS 공격에 효과적인지 확인
            - XSS란 Cross Site Script의 약자로 제 3자가 삽입한 스크립트를 통해 공격하는 기법이다.
            - CSP란 Content Security Policy의 약자로 웹 사이트에서 호출할 수 있는 컨텐츠를 제한하는 정책을 말한다.
    - 라이브러리
        - 감지된 JavaScript 라이브러리
            - 페이지 내에서 감지되는 자바스크립트 라이브러리다.
    - HTTPS 사용
    - 페이지 로드 시 위치정보 권한 요청 방지하기: 사용자의 동의 없이 위치기반 web api를 사용하는지 확인한다.
    - 페이지 로드 시 알림 권한 요청 방지하기: 사용자의 동의 없이 웹 페이지 알림을 요청하는 api를 사용하는지 확인한다.
    - 위험한 자바스크립트 라이브러리 사용하지 않음
    
    이 밖에도 다양한 지표가 존재한다.
    
- 검색 엔진 최적화
    - 검색 엔진 최적화란 웹 페이지가 구글과 같은 검색 엔진이 쉽게 웹페이지 정보를 가져가서 공개할 수 있도록 최적화돼 있는지를 확인하는 것을 의미한다.
    - 검색엔진 최적화를 할 수 있도록 가이드라인을 제시하기도 한다.

### 기간 모드(Timespan)

기간 모드는 실제 웹 페이지를 탐색하는 동안 지표를 측정한다. 이 모드에서 확인할 수 있는 지표들은 크게 성능과 권장 사항이다. 대다수의 사용자가 빈번하게 수행할 것으로 예상되는 작업을 기간 모드로 측정하면 성능 최적화에 큰 도움을 얻을 수 있다.

- 트리맵
    - 페이지를 불러올 때 함께 로딩한 모든 리소스를 함께 모아서 볼 수 있는 곳이다. 웹 페이지 전체 리소스 중 어떤 파일이 어느 정도를 차지했는지 비율로 확인할 수 있으며 실제 데이터 크기역시 확인할 수 있다.
    - 이때 로딩한 리소스에서 사용하지 않은 바이트의 크기를 확인할 수도 있다.

### 스냅샷

현재 페이지 상태를 기준으로 성능을 측정한다. 현재 상태에서의 SEO, 접근성, 성능 등을 분석할 수 있다.

## WebPage Test

웹 사이트의 성능과 로딩 과정에서 일어나는 일을 분석하는 데 좋은 도구다. 해당 도구에서 제공하는 기능은 크게 다섯 가지다.

- **Site Performance**: 웹 사이트 성능 분석
- Core Web Vitals: 웹 사이트의 핵심 웹 지표 확인
- Lighthouse: 구글 라이트 하우스
- Visual Comparison: 2개 이상의 사이트를 동시에 실행해 시간의 흐름에 따른 로딩 과정을 비교
- Traceroute: 네트워크 경로 확인

Site Performance 도구를 바탕으로 성능을 측정하는 방법을 알아보자.

공식 페이지에 접속한 뒤 Site Performance를 선택하고 분석을 원하는 웹 사이트 주소를 입력하여 테스트 할 수 있다.

### Performance Summary

전체적인 측정 결과를 요약할 수 있는데, 성능 테스트는 총 3번 이뤄지고 3개의 서로 다른 결과를 확인할 수 있다. 측정 결과는 크게 세 가지 영역으로 나눠져 있다.

- Opportunities & Experiments: 웹사이트에 대한 평가를 총 3가지로 나눠 보여준다.
    - Is it Quick: 페이지가 충분히 빠른지 평가한다. TTFB, LCP와 같은 시간적 지표를 측정한다.
    - Is it Usable: 웹 사이트의 사용성과 시각적인 요소를 확인한다. 콘텐츠 누적 이동, 상호작용 속도, 접근 성 이슈 등을 점검한다.
    - Is it Reslient: 보안 취약성을 점검한다.
- Observed Metrics: 최초 바이트까지의 시간, 렌더링 시작에 소요되는 시간, 최초 콘텐츠풀 페인트 등 다양한 시간 지표에 대한 정보를 나타낸다.
- Indivisual Runs: 3번의 측정 결과를 각각 볼 수 있다.

## 크롬 개발자 도구

웹 페이지의 문제를 다세히 들여다 보기 위해서 크롬 개발자 도구를 사용할 수 있다.

### 성능 통계

크롬 개발자 도구의 Performance Insight는 웹 사이트의 성능을 자세하게 확인할 수 있는 도구다. 라이트 하우스와 비슷하게 웹 사이트 로딩 시작부터 끝까지를 확인하거나 원하는 액션을 수행하면서 웹 사이트 성능을 측정할 수 있다.

또한 고의로 네트워크와 CPU 속도를 지연시켜 상대적으로 열악한 환경을 재현할 수 있다. 

- Insight
    - 성능 측정 기간 동안 개발자가 눈여겨봐야 할 여러가지 요소를 한눈에 확인할 수 있도록 도와준다.
    - 핵심 웹 지표 (FCP, LCP)를 볼 수 있고, Dom Content Loaded가 언제 일어났는지 볼 수 있다.
    - Long Task: 메인 스레드에서 실행되는데 오랜 시간으로 분류된 긴 작업을 의미한다.
        - 어떤 함수로 인해 오랜 시간 작업이 이뤄져 있는지 확인할 수 있다.
        - 함수의 위치로 이동할 수 있어 어떤 함수를 수정해야 할지 어느정도 파악할 수 있다.
    - Render blocking CSS: 렌더링을 막는 CSS를 확인할 수 있다.
        - 중요하지 않은 스타일이라면 link rel=”preload” as=”style”로 스타일을 비동기적으로 요청한다.
        - 미디어 쿼리를 활용해 디바이스에 필요한 스타일만 불러온다.
        - CSS 내부의 띄어쓰기, 줄바꿈 등을 압축해 크기를 줄인다.
    - Forced Style recalculation: 이미 스타일이 한번 계산된 이후에 어떠한 이유로 스타일이 다시금 계산되는 작업이 발생됐음을 의미한다.
- 메인 메뉴
    - 시간의 흐름에 따라 화면이 얼마나 그려졌는지 점검하면서 원하는 대로 페이지가 렌더링됐는지 확인할 수 있다.
    - Layout Shift 영역에서 누적 레이아웃이 일어난 경우 확인할 수 있다.
    - Network에서는 성능 측정 기간동안 발생한 네트워크 요청을 모두 확인할 수 있다.
    - Renderer에서는 렌더러가 어떤 작업을 하고 있는지 확인할 수 있다.
    - Timing은 User Timing API와 관련된 기록이 남아있다.

### 성능

성능 측정에 대한 정보를 조금 더 세밀하게 확인해 볼 수 있다.